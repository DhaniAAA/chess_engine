name: SPSA Tuning

on:
  workflow_dispatch:
    inputs:
      iterations:
        description: 'Number of SPSA iterations (recommended: 50-200)'
        required: true
        default: '50'
      fen_count:
        description: 'Number of FEN positions to load from EPD (max 5000)'
        required: true
        default: '500'
      positions_per_iter:
        description: 'Positions to sample per iteration (10-50)'
        required: true
        default: '20'
      search_depth:
        description: 'Search depth for evaluation (3-8)'
        required: true
        default: '4'

jobs:
  spsa-tuning:
    runs-on: ubuntu-latest
    timeout-minutes: 360  # 6 hours max

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Setup Build Tools
        run: |
          sudo apt-get update
          sudo apt-get install -y g++ make

      - name: Build Chess Engine
        run: |
          make clean || true
          make -j$(nproc)
          chmod +x output/main.exe || chmod +x output/main || true
          ls -la output/

      - name: Run SPSA Tuning
        run: |
          python tuner/spsa_tuner.py \
            --engine ./output/main.exe \
            --iterations ${{ github.event.inputs.iterations }} \
            --fen-count ${{ github.event.inputs.fen_count }} \
            --positions-per-iter ${{ github.event.inputs.positions_per_iter }} \
            --search-depth ${{ github.event.inputs.search_depth }} \
            --simple \
            --output tuner/spsa_results.json

      - name: Generate Best Parameters File
        run: |
          python -c "
import json

# Load results
with open('tuner/spsa_results.json', 'r') as f:
    data = json.load(f)

# Generate C++ header with best parameters
cpp_content = '''// ============================================================================
// SPSA Tuned Parameters
// Generated by GitHub Actions SPSA Tuner
// Iterations: ${{ github.event.inputs.iterations }}
// FEN Count: ${{ github.event.inputs.fen_count }}
// ============================================================================

#ifndef TUNED_PARAMS_HPP
#define TUNED_PARAMS_HPP

namespace TunedParams {

'''

for name, value in data['best_params'].items():
    cpp_content += f'constexpr int {name} = {value};\\n'

cpp_content += '''
} // namespace TunedParams

#endif // TUNED_PARAMS_HPP
'''

with open('tuner/tuned_params.hpp', 'w') as f:
    f.write(cpp_content)

# Generate simple text summary
summary = 'SPSA TUNING RESULTS\\n'
summary += '=' * 50 + '\\n\\n'
summary += 'Configuration:\\n'
summary += f'  Iterations: ${{ github.event.inputs.iterations }}\\n'
summary += f'  FEN Count: ${{ github.event.inputs.fen_count }}\\n'
summary += f'  Positions/Iter: ${{ github.event.inputs.positions_per_iter }}\\n'
summary += f'  Search Depth: ${{ github.event.inputs.search_depth }}\\n\\n'
summary += 'Best Parameters:\\n'
for name, value in data['best_params'].items():
    summary += f'  {name}: {value}\\n'

with open('tuner/best_params.txt', 'w') as f:
    f.write(summary)

print(summary)
"

      - name: Upload Tuning Results
        uses: actions/upload-artifact@v4
        with:
          name: spsa-tuning-results
          path: |
            tuner/spsa_results.json
            tuner/tuned_params.hpp
            tuner/best_params.txt
          retention-days: 90

      - name: Create Job Summary
        run: |
          echo "## ðŸŽ¯ SPSA Tuning Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Configuration" >> $GITHUB_STEP_SUMMARY
          echo "| Setting | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Iterations | ${{ github.event.inputs.iterations }} |" >> $GITHUB_STEP_SUMMARY
          echo "| FEN Count | ${{ github.event.inputs.fen_count }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Positions/Iter | ${{ github.event.inputs.positions_per_iter }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Search Depth | ${{ github.event.inputs.search_depth }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Best Parameters" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          cat tuner/best_params.txt >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“¥ **Download the tuned parameters from the Artifacts section above.**" >> $GITHUB_STEP_SUMMARY
