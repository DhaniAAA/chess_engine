name: Texel Tuner

on:
  workflow_dispatch:
    inputs:
      max_positions:
        description: "Maximum positions to use (50000-2000000)"
        required: true
        default: "500000"
      iterations:
        description: "Number of tuning iterations (10-200)"
        required: true
        default: "100"

jobs:
  tune:
    runs-on: ubuntu-latest
    timeout-minutes: 360 # 6 hours max

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y g++ make

      - name: Download EPD dataset
        run: |
          mkdir -p tuner
          if [ ! -f tuner/quiet-labeled.epd ]; then
            echo "Downloading quiet-labeled.epd..."
            # Download from common chess tuning datasets
            wget -q "https://github.com/official-stockfish/Stockfish/raw/master/src/../../../wiki/Texel-tuning-resources/quiet-labeled.epd" -O tuner/quiet-labeled.epd 2>/dev/null || \
            echo "Using existing EPD file or download from your source"
          fi
          # Show file info
          if [ -f tuner/quiet-labeled.epd ]; then
            wc -l tuner/quiet-labeled.epd
          else
            echo "WARNING: EPD file not found. Please ensure tuner/quiet-labeled.epd is in the repository."
          fi

      - name: Build Tuner
        run: |
          echo "Building tuner with optimizations..."
          make tuner CXX=g++ CXXFLAGS="-std=c++17 -O3 -march=native -DNDEBUG -pthread"

      - name: Run Texel Tuner
        run: |
          echo "Starting Texel Tuning..."
          echo "Positions: ${{ github.event.inputs.max_positions }}"
          echo "Iterations: ${{ github.event.inputs.iterations }}"
          echo ""
          ./output/tuner tuner/quiet-labeled.epd ${{ github.event.inputs.max_positions }} ${{ github.event.inputs.iterations }} | tee tuning_results.txt

      - name: Upload Results
        uses: actions/upload-artifact@v4
        with:
          name: tuning-results
          path: tuning_results.txt
          retention-days: 30

      - name: Display Final Values
        run: |
          echo "============================================"
          echo "TUNING COMPLETE - Final Values:"
          echo "============================================"
          grep -A 20 "FINAL TUNED VALUES" tuning_results.txt || true
